<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Transactions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        tr th{
            background: linear-gradient(0.25turn, #CCCCFF, #DA70D6) fixed;
        }
    </style>
    <title>Transaction History</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row">

            <div class="p-0 col-md-2">
                <div th:replace="~{navbar :: sidebar('transaction')}"></div>
            </div>

            <div class="col-md-10">
                <div class="m-2 text-success" th:if="${TransactionUpdateSuccessMessage}"> <!-- flash attribute from update POST -->
                    <p th:text="${TransactionUpdateSuccessMessage}"></p>
                </div>

                <div class="m-2 text-success" th:if="${TransactionDeleteSuccessMessage}"> <!-- flash attribute from update POST -->
                    <p th:text="${TransactionDeleteSuccessMessage}"></p>
                </div>

                <div class="row">
                    <div class="col-12 m-3">
                        <table class="table table-striped">
                            <colgroup>
                                <col style="width: 10%;">
                                <col style="width: 30%;">
                                <col style="width: 30%">
                                <col style="width: 20%;">
                                <col style="width: 10%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th scope="col">Category</th>
                                <th scope="col">Name</th>
                                <th scope="col">Date</th>
                                <th scope="col">Amount</th>
                                <th scope="col">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="transaction : ${transactions}">
                                <td th:style="'background-color:' + ${colorMap[transaction.details.categoryId].color}"
                                    class="border">
                                    <label th:text="${colorMap[transaction.details.categoryId].name}" class="color-cell"
                                    th:attr="data-color=${colorMap[transaction.details.categoryId].name}"></label>
                                </td>
                                <td th:text="${transaction.details.name}"></td>
                                <td th:text="${#temporals.format(transaction.details.timestamp, 'yyyy-MM-dd HH:mm')}"></td>
                                <td th:text="${transaction.details.value}"
                                    th:classappend="${transaction.details.value} > 0 ? 'text-success' : 'text-danger'"></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary me-1"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editTransaction"
                                            th:attr="
                                                data-id=${transaction.id},
                                                data-name=${transaction.details.name},
                                                data-value=${transaction.details.value},
                                                data-category-id=${transaction.details.categoryId},
                                                data-notes=${transaction.details.notes},
                                                data-timestamp=${transaction.details.timestamp}"
                                            onclick="editTransaction(this)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteTransaction"
                                            th:attr="data-id=${transaction.id}"
                                            onclick="deleteTransaction(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tbody>
                        </table>

                    </div>
                </div>
                <div class="row">
                    <nav>
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:each="pageNumber : ${#numbers.sequence(1, pageCount, 1)}">
                                <a class="page-link" th:href="@{/transaction/all(page=${pageNumber})}" th:text="${pageNumber}"
                                   th:classappend="${pageNumber == page} ? active">PageNumber</a>
                            </li>
                        </ul>
                    </nav>
                </div>

            </div>
        </div>
    </div>


<div class="modal fade" id="editTransaction" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Transaction Details</h5>
            </div>
            <div class="modal-body">
                <form th:action="@{/transaction/update}" th:object="${transaction_edit_dto}" method="post" id="update_form">
                    <input type="hidden" th:field="*{id}" name="id">
                    <div class="mx-auto h-100 mb-4" style="width: 200px">
                        <label>
                            <input type="number" placeholder="Amount" name="value" th:field="*{details.value}"
                                   style="border-width: 0 0 1px 0; outline: none">
                        </label>
                        <div>
                            <p th:if="${#fields.hasErrors('details.value')}" th:errorclass="text-danger"
                               th:errors="*{details.value}" class="error-message">error goes here</p>
                        </div>
                    </div>
                    <div class="row mt-2 mb-4">
                        <div class="col-md-8">
                            <input type="text" placeholder="Name" name="name" th:field="*{details.name}" class="form-control">
                            <div th:if="${#fields.hasErrors('details.name')}" th:errorclass="text-danger"
                               th:errors="*{details.name}" class="error-message">error goes here</div>
                        </div>


                        <div class="col-md-4">
                            <input type="datetime-local" name="details.timestamp"
                                   th:value="${#temporals.format(transaction_edit_dto.details.timestamp, 'yyyy-MM-dd''T''HH:mm')}" class="form-control">
                            <div th:if="${#fields.hasErrors('details.timestamp')}" th:errorclass="text-danger"
                                 th:errors="*{details.timestamp}" class="error-message">errors goes here</div>
                        </div>
                    </div>
                    <div class="row justify-content-center align-content-center">

                        <div class="mb-4">
                            <ul style="column-count: 5; list-style-type: none">
                                <li th:each="category: ${categories}">
                                    <input type="radio" th:field="*{details.categoryId}"
                                           th:value="${category.id}"
                                           name="categoryId">
                                    <label th:for="${#ids.prev('details.categoryId')}" th:text="${category.name}"
                                           th:style="'background-color: ' + ${category.color}"
                                           class=" badge rounded colored-text border"></label> <!-- for attr working somehow -->
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group" style="width: 75%; margin: auto">
                        <textarea placeholder="Notes..."
                                  name="notes"
                                  th:field="*{details.notes}"
                                  class="form-control"
                                  rows="5" ></textarea>
                    </div>
                    <button type="submit" class="mt-3 btn btn-success" style="margin: 50%" >Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteTransaction" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                Confirm deletion?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                <form th:action="@{/transaction/delete}" method="post" id="delete_form">
                    <input type="hidden" id="IdToDelete" name="id">
                    <button type="submit" class="btn btn-danger" id="confirmDelete">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>


</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@2.0.4"
        integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>

<script>
     function editTransaction(button) {
            const form = document.getElementById('update_form');
            if (!form) {
                console.error("Form not found");
                return;
            }

            try {
                // Check if the input elements exist
                const idInput = form.querySelector('input[name="id"]');
                const nameInput = form.querySelector('input[name="details.name"]');
                const valueInput = form.querySelector('input[name="details.value"]');
                const notesTextarea = form.querySelector('textarea[name="details.notes"]');
                const timestampInput = form.querySelector('input[name="details.timestamp"]');
                console.log("ID Input:", idInput);
                console.log("Name Input:", nameInput);
                console.log("Value Input:", valueInput);
                console.log("Notes Textarea:", notesTextarea);
                console.log("Timestamp Input:", timestampInput.value);

                if (!idInput || !nameInput || !valueInput || !notesTextarea || !timestampInput) {
                    console.error("One or more form elements are missing.");
                    return;
                }

                // Set values
                idInput.value = button.dataset.id || "";
                nameInput.value = button.dataset.name || "";
                valueInput.value = button.dataset.value || "";
                notesTextarea.value = button.dataset.notes || "";
                timestampInput.value = button.dataset.timestamp || "";
                console.log(timestampInput.value)
                // Set the correct category
                const radios = form.querySelectorAll('input[name="details.categoryId"]');
                radios.forEach(radio => {
                    radio.checked = radio.value === button.dataset.categoryId;
                });
                console.log(radios)

                document.querySelectorAll("div.error-message").forEach(p => p.textContent = '');

            } catch (err) {
                console.error("Error setting form values:", err);
            }
        }

        // const deleteButtons = document.querySelectorAll('[data-bs-target="#deleteTransaction"]');
        function deleteTransaction(button){
                const deleteForm = document.getElementById("delete_form")
                const idToDelete = deleteForm.querySelector('input[name="id"]')
                idToDelete.value = button.dataset.id
        }

</script>

<script>
    const getTextColor = bg => {
        const rgb = bg.match(/\d+/g).map(Number)
        const luminance = 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]
        return luminance > 186 ? '#000' : '#fff'
    }
    document.addEventListener("DOMContentLoaded", () => {

        document.querySelectorAll('.color-cell').forEach(label => {
            const parent = label.closest('td')
            if (!parent) return

            const bg = getComputedStyle(parent).backgroundColor
            const textColor = getTextColor(bg)

            label.style.color = textColor
        })
    })

    document.querySelectorAll('.colored-text').forEach(label => {
        const bg = getComputedStyle(label).backgroundColor
        const textColor = getTextColor(bg)

        label.style.color = textColor
    })
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const shouldShowModal = [[${showModal}]];
    if (shouldShowModal) {
        const modal = new bootstrap.Modal(document.getElementById('editTransaction'));
        modal.show();
    }
    /*]]>*/
</script>
</html>