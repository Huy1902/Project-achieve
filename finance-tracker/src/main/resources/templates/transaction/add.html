<!DOCTYPE html>
<html lang="en" xmlns:hx-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Add Transaction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <script src="https://unpkg.com/htmx.org@2.0.4"
    integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    <!-- add htmx later -->
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 p-0">
                <div th:replace="~{navbar :: sidebar('transactionAdd')}"></div>
            </div>

            <div class="col-md-10">
                <div class="border min-vh-100 flex-grow-1 p-3">
                    <h1>Add Transaction</h1>
                    <div class="m-2 text-success" th:if="${TransactionAddSuccessMessage}"> <!-- flash attribute from update POST -->
                        <p th:text="${TransactionAddSuccessMessage}"></p>
                    </div>

                    <div class="m-2 text-success" th:if="${CategoryAddSuccessMessage}"> <!-- flash attribute from update POST -->
                        <p th:text="${CategoryAddSuccessMessage}"></p>
                    </div>

                    <form th:action="@{/transaction/add}" th:object="${transaction_dto}" method="post">
                        <div class="mx-auto h-100 mb-4" style="width: 200px">
                            <label>
                                <input type="number" placeholder="Amount" name="value" th:field="*{value}" style="border-width: 0 0 1px 0; outline: none">
                            </label>
                            <div th:if="${#fields.hasErrors('value')}" th:errorclass="text-danger"
                               th:errors="*{value}" class="error-message">errors goes here</div>
                        </div>
                        <div class="row mt-2 mb-4">
                            <div class="col-md-8">
                                <input type="text" placeholder="Name" name="name" th:field="*{name}" class="form-control">
                                <div th:if="${#fields.hasErrors('name')}" th:errorclass="text-danger"
                                     th:errors="*{name}" class="error-message">errors goes here</div>
                            </div>

                            <div class="col-md-4">
                                <input type="datetime-local" name="timestamp" th:field="*{timestamp}" class="form-control">
                                <div th:if="${#fields.hasErrors('timestamp')}" th:errorclass="text-danger"
                                     th:errors="*{timestamp}" class="error-message">errors goes here</div>
                            </div>


                        </div>
                        <div class="row justify-content-center align-content-center">
                            <div class="mb-4">
                                <ul style="column-count: 5; list-style-type: none">
                                    <li th:each="category: ${categories}">
                                        <input type="radio" th:field="*{categoryId}" th:value="${category.id}" name="categoryId">
                                        <!-- not sure what that th:value field is for rn but would rather not touch it -->
                                        <label th:for="${#ids.prev('categoryId')}" th:text="${category.name}"
                                               th:style="'background-color: ' + ${category.color}"
                                               class="badge rounded colored-text border"></label> <!-- for attr working somehow -->
                                    </li>
                                    <li>
                                        <button type="button" data-bs-toggle="modal" data-bs-target="#modal-add-category"
                                                class="btn btn-primary rounded m-3" style="background-color: indigo">+ Add new</button>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="form-group" style="width: 75%; margin: auto">
                            <textarea placeholder="Notes..." name="notes" th:field="*{notes}" class="form-control" rows="5" ></textarea>
                        </div>
                        <button type="submit" class="mt-3 btn btn-success" style="margin: 50%" >Add</button>

                    </form>

                </div>
            </div>
        </div>

    </div>

    <div id ="modal-add-category"
         class="modal modal-blur fade"
         style="display: none"
         aria-hidden="false"
         tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content" id="modal-content" th:insert="~{category/addCategory.html :: addCategory('/transaction/add')}">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <script>
        const modal = document.getElementById('modal-add-category')
        modal.addEventListener('hidden.bs.modal', function () {
            /* message field in add category modal (see addCategory.html) */
            document.querySelectorAll('p.error-message').forEach(p => p.textContent = '')
            }
        )
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const showModal = [[${showCategoryModal}]];
        if (showModal) {
            const modal = new bootstrap.Modal(document.getElementById('modal-add-category'));
            modal.show();
        }
        /*]]>*/
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const getTextColor = bg => {
                const rgb = bg.match(/\d+/g).map(Number)
                const luminance = 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]
                return luminance > 186 ? '#000' : '#fff'
            }

            document.querySelectorAll('.colored-text').forEach(label => {
                const bg = getComputedStyle(label).backgroundColor
                const textColor = getTextColor(bg)

                label.style.color = textColor
            })
        })
    </script>
</body>
</html>